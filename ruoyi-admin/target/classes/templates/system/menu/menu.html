<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
	<head th:include="include :: header"></head>
	<body class="gray-bg">

		<div class="container-div">
			<div class="row">
				<div class="col-sm-12 search-collapse">
					<form id="menu-form">
						<div class="select-list">
							<ul>
								<li>
									菜单名称：<input type="text" name="menuName"/>
								</li>
								<li>
									菜单状态：<select name="visible" th:with="type=${@dict.getType('sys_show_hide')}">
									<option value="">所有</option>
									<option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}"></option>
								</select>
								</li>
								<li>
									<a class="btn btn-primary btn-rounded btn-sm" onclick="$.treeTable.search()"><i class="fa fa-search"></i>&nbsp;搜索</a>
									<a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
								</li>
							</ul>
						</div>
					</form>
				</div>

				<div class="btn-group-sm" id="toolbar" role="group">
					<a class="btn btn-success" onclick="$.operate.add(0)" shiro:hasPermission="system:menu:add">
						<i class="fa fa-plus"></i> 新增
					</a>
					<a class="btn btn-primary" onclick="$.operate.edit()" shiro:hasPermission="system:menu:edit">
						<i class="fa fa-edit"></i> 修改
					</a>
					<a class="btn btn-warning" onclick="$.table.exportExcel()" shiro:hasPermission="system:menu:export">
						<i class="fa fa-download"></i> 导出
					</a>
					<a class="btn btn-info" onclick="importExcel()">
						<i class="fa fa-upload"></i> 导入
					</a>
					<a class="btn btn-info" id="expandAllBtn">
						<i class="fa fa-exchange"></i> 展开/折叠
					</a>
				</div>
				<div class="col-sm-12 select-table table-striped">
					<table id="bootstrap-tree-table"></table>
				</div>
			</div>
		</div>

		<th:block th:include="include :: footer" />
		<script th:inline="javascript">
			var addFlag = [[${@permission.hasPermi('system:menu:add')}]];
			var editFlag = [[${@permission.hasPermi('system:menu:edit')}]];
			var removeFlag = [[${@permission.hasPermi('system:menu:remove')}]];
			var datas = [[${@dict.getType('sys_show_hide')}]];
			var prefix = ctx + "system/menu";

			$(function() {
				var options = {
					code: "menuId",
					parentCode: "parentId",
					uniqueId: "menuId",
					expandAll: false,
					expandFirst: false,
					url: prefix + "/list",
					createUrl: prefix + "/add/{id}",
					updateUrl: prefix + "/edit/{id}",
					removeUrl: prefix + "/remove/{id}",
                    exportUrl: prefix + "/export",
					modalName: "菜单",
					columns: [{
						field: 'selectItem',
						radio: true
					},
						{
							title: '菜单名称',
							field: 'menuName',
							width: '20%',
							formatter: function(value, row, index) {
								if ($.common.isEmpty(row.icon)) {
									return row.menuName;
								} else {
									return '<i class="' + row.icon + '"></i> <span class="nav-label">' + row.menuName + '</span>';
								}
							}
						},
						{
							field: 'orderNum',
							title: '排序',
							width: '10%',
							align: "left"
						},
						{
							field: 'url',
							title: '请求地址',
							width: '15%',
							align: "left"
						},
						{
							title: '类型',
							field: 'menuType',
							width: '10%',
							align: "left",
							formatter: function(value, item, index) {
								if (item.menuType == 'M') {
									return '<span class="label label-success">目录</span>';
								}
								else if (item.menuType == 'C') {
									return '<span class="label label-primary">菜单</span>';
								}
								else if (item.menuType == 'F') {
									return '<span class="label label-warning">按钮</span>';
								}
							}
						},
						{
							field: 'visible',
							title: '可见',
							width: '10%',
							align: "left",
							formatter: function(value, row, index) {
								return $.table.selectDictLabel(datas, row.visible);
							}
						},
						{
							field: 'perms',
							title: '权限标识',
							width: '15%',
							align: "left",
						},
						{
							title: '操作',
							width: '20%',
							align: "left",
							formatter: function(value, row, index) {
								var actions = [];
								actions.push('<a class="btn btn-success btn-xs ' + editFlag + '" href="javascript:void(0)" onclick="$.operate.edit(\'' + row.menuId + '\')"><i class="fa fa-edit"></i>编辑</a> ');
								actions.push('<a class="btn btn-info btn-xs ' + addFlag + '" href="javascript:void(0)" onclick="$.operate.add(\'' + row.menuId + '\')"><i class="fa fa-plus"></i>新增</a> ');
								actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.menuId + '\')"><i class="fa fa-trash"></i>删除</a>');
								return actions.join('');
							}
						}]
				};
				$.treeTable.init(options);
			});
		</script>
		<script>
            // 导入数据
            function importExcel(formId){
                var currentId = $.common.isEmpty(formId) ? 'importTpl' : formId;
                layer.open({
                    type: 1,
                    area: ['400px', '230px'],
                    fix: false,
                    //不固定
                    maxmin: true,
                    shade: 0.3,
                    title: '导入' + $.table._option.modalName + '数据',
                    content: $('#' + currentId).html(),
                    btn: ['<i class="fa fa-check"></i> 导入', '<i class="fa fa-remove"></i> 取消'],
                    // 弹层外区域关闭
                    shadeClose: true,
                    btn1: function(index, layero){
                        var file = layero.find('#file').val();
                        if (file == '' || (!$.common.endWith(file, '.xls') && !$.common.endWith(file, '.xlsx'))){
                            $.modal.msgWarning("请选择后缀为 “xls”或“xlsx”的文件。");
                            return false;
                        }
                        var index = layer.load(2, {shade: false});
                        //$.modal.disable();
                        // 禁用按钮
                        function disable() {
                            var doc = window.top == window.parent ? window.document : window.parent.document;
                            $("a[class*=layui-layer-btn]", doc).addClass("layer-disabled");
                        };
                        var formData = new FormData();
                        formData.append("file", $('#file')[0].files[0]);
                        formData.append("updateSupport", $("input[name='updateSupport']").is(':checked'));
                        $.ajax({
                            url: $.table._option.importUrl,
                            data: formData,
                            cache: false,
                            contentType: false,
                            processData: false,
                            type: 'POST',
                            success: function (result) {
                                if (result.code == web_status.SUCCESS) {
                                    // 关闭全部窗体
                                    layer.closeAll();
                                    // 成功提示
                                    function alertSuccess(content) {
                                        // 弹出提示
                                        layer.alert(content, {
                                            icon: $.modal.icon("success"),
                                            title: "系统提示",
                                            btn: ['确认'],
                                            btnclass: ['btn btn-primary'],
                                        });
                                    }
                                    $.table.refresh();
                                } else if (result.code == web_status.WARNING) {
                                    layer.closeAll();
                                    // 启用按钮
                                    function enable() {
                                        var doc = window.top == window.parent ? window.document : window.parent.document;
                                        $("a[class*=layui-layer-btn]", doc).removeClass("layer-disabled");
                                    }
                                    // 成功提示
                                    function alertSuccess(content) {
                                        // 弹出提示
                                        layer.alert(content, {
                                            icon: $.modal.icon("success"),
                                            title: "系统提示",
                                            btn: ['确认'],
                                            btnclass: ['btn btn-primary'],
                                        });
                                    }
                                    $.modal.alert("warning");
                                } else {
                                    layer.closeAll();
                                    function enable() {
                                        var doc = window.top == window.parent ? window.document : window.parent.document;
                                        $("a[class*=layui-layer-btn]", doc).removeClass("layer-disabled");
                                    }
                                    // 错误提示
                                    function alertError(content) {
                                        // 弹出提示
                                        layer.alert(content, {
                                            icon: $.modal.icon("fail"),
                                            title: "系统提示",
                                            btn: ['确认'],
                                            btnclass: ['btn btn-primary'],
                                        });
                                    }
                                    $.modal.alert("操作失败，插入数据与现有数据重复");
                                }
                            }
                        });
                    }
                });
            }
		</script>
	</body>
</html>